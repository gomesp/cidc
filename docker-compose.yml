version: "2.2"

services:
  keycloak:
    build: keycloak
    image: ci-stack-keycloak
    ports:
      - 8280:8080
    labels:
      - com.github.joostvdg.namespace=cidc
      - com.github.joostvdg.name="Keycloak"
      - com.github.joostvdg.description="Single Sign On facility"
      - com.github.joostvdg.webPath=/
      - com.github.joostvdg.webPort=8280
    links:
      - postgres
    depends_on:
      - postgres
      - ldap
    environment:
      - KEYCLOAK_USER=admin
      - KEYCLOAK_PASSWORD=admin
      - PROXY_ADDRESS_FORWARDING=true 
      - KEYCLOAK_LOGLEVEL=DEBUG
      - DB_VENDOR=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DATABASE=docker
      - POSTGRES_USER=docker
      - POSTGRES_PASSWORD=docker
      - POSTGRES_PORT_5432_TCP_ADDR=postgres
      - POSTGRES_PORT_5432_TCP_PORT=5432
    command: -b 0.0.0.0 -Dkeycloak.import=/tmp/realms/ci-realm-export.json
  
  docs:
    build: docs
    image: ci-stack-docs
    labels:
      - com.github.joostvdg.namespace=cidc
      - com.github.joostvdg.name="Docs"
      - com.github.joostvdg.description="User documentation"
      - com.github.joostvdg.webPath=/
      - com.github.joostvdg.webPort=8281
    ports:
      - 8281:80

  jenkins:
    build: jenkins
    image: ci-stack-jenkins
    labels:
      - com.github.joostvdg.namespace=cidc
      - com.github.joostvdg.name="Jenkins Master"
      - com.github.joostvdg.description="Jenkins - CI/Build server"
      - com.github.joostvdg.webPath=/jenkins
      - com.github.joostvdg.webPort=8282
    environment:
      - HOSTNAME=${JENKINS_HOSTNAME:-localhost}
      - EXTERNAL_PORT=${JENKINS_EXTERNAL_PORT:-8282}
      - CONTEXT_ROOT=${JENKINS_CONTEXT_ROOT:-/jenkins}
      - KEYCLOAK_HOSTNAME=${hostname:-localhost}
      - KEYCLOAK_PORT=${KEYCLOAK_PORT:-8280}
      - KEYCLOAK_HOSTNAME_SUFFIX=${KEYCLOAK_HOSTNAME_SUFFIX:-.solon.prd}
      - KEYCLOAK_HOSTNAME_LOWERCASE=${KEYCLOAK_HOSTNAME_LOWERCASE:-true}
      - SONAR_HOSTNAME=${SONAR_HOSTNAME:-sonar}
      - NEXUS_HOSTNAME=${NEXUS_HOSTNAME:-nexus}
    ports:
      - 8282:8080
      - 50000:50000
    volumes: ["jenkins_data:/var/jenkins_home"]

  jenkins-slave:
    image: vfarcic/jenkins-swarm-agent:18.02.12-10
    labels:
      - com.github.joostvdg.namespace=cidc
      - com.github.joostvdg.name="Jenkins Slave"
      - com.github.joostvdg.description="Slave with link to docker socket"
    depends_on:
      - jenkins
    environment:
      - COMMAND_OPTIONS=-master http://jenkins:8080/jenkins -labels 'docker' -executors 2
    volumes: ["jenkins_slave_workspace:/workspace", "/var/run/docker.sock:/var/run/docker.sock"]

  sonar:
    image: ci-stack-sonar
    build: sonar
    labels:
      - com.github.joostvdg.namespace=cidc
      - com.github.joostvdg.name="SonarQube"
      - com.github.joostvdg.webPath=/sonar
      - com.github.joostvdg.webPort=8289
      - com.github.joostvdg.description="SonarQube - for software quality scan"
    ports:
      - 8289:9000    
    volumes: ["sonar_data:/opt/sonarqube/data"]
    command: -Dsonar.web.context=/sonar

  postgres:
    image: postgres:9.6.7
    labels:
      - com.github.joostvdg.namespace=cidc
      - com.github.joostvdg.name="Postgres"
      - com.github.joostvdg.description="Database for Keycloak"
    ports:    
      - 5432:5432
    environment:
      - POSTGRES_PASSWORD=docker
      - POSTGRES_USER=docker
      - POSTGRES_DB=docker
    volumes:
      - pg_data:/var/lib/postgresql/data

  pgadmin4:
    image: chorss/docker-pgadmin4
    labels:
      - com.github.joostvdg.namespace=cidc
      - com.github.joostvdg.name="PGAdmin 4"
      - com.github.joostvdg.description="Web admin console for postgres"
      - com.github.joostvdg.webPath=/
      - com.github.joostvdg.webPort=5050
    depends_on:
      - postgres
    ports:
      - 5050:5050
    environment:
      - POSTGRES_PASSWORD=docker
      - POSTGRES_USER=docker
      - POSTGRES_DB=docker
    volumes:
      - pgadmin_data:/data


  # Default Nexus 3 images is poor for mounting data
  # https://github.com/cavemandaveman/nexus
  nexus:                               
    image: cavemandaveman/nexus
    labels:
      - com.github.joostvdg.namespace=cidc
      - com.github.joostvdg.name="Nexus 3"
      - com.github.joostvdg.description="Binary repository"
      - com.github.joostvdg.webPath=/nexus
      - com.github.joostvdg.webPort=8284
    ports:
      - 8284:8081
    volumes: ["nexus_data:/nexus-data"]

  portainer:
    image: portainer/portainer
    labels:
      - com.github.joostvdg.namespace=cidc
      - com.github.joostvdg.name="Portainer"
      - com.github.joostvdg.description="Admin console for Docker"
      - com.github.joostvdg.webPath=/
      - com.github.joostvdg.webPort=9000
    ports:
      - 9000:9000
    volumes: ["/var/run/docker.sock:/var/run/docker.sock","portainer_data:/data portainer/portainer"]

  ldap: 
    image: ci-stack-opendj 
    labels:
      - com.github.joostvdg.namespace=cidc
      - com.github.joostvdg.name="OpenDJ"
      - com.github.joostvdg.description="LDAP server for user management"
    build: ldap 
    ports: 
      - 11389:1389 
      - 11636:1636 
      - 14444:4444

volumes:
  sonar_data:
  nexus_data:
  jenkins_data:
  jenkins_slave_workspace:
  artifactory_data:
  pgadmin_data:
  pg_data:
  portainer_data:
